<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Material Cost Calculator</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2, h3 {
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 12px 16px;
            transition: 0.3s;
            font-size: 16px;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #4CAF50;
            color: white;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .dashboard-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        .dashboard-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .material-selection {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 5px;
            align-items: center;
            margin-bottom: 10px;
        }
        .material-selection label {
            margin-bottom: 5px;
        }
        .file-input {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Product Material Cost Calculator</h1>
        
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'Dashboard')" id="defaultOpen">Dashboard</button>
            <button class="tablinks" onclick="openTab(event, 'Products')">Products</button>
            <button class="tablinks" onclick="openTab(event, 'Materials')">Materials</button>
            <button class="tablinks" onclick="openTab(event, 'Admin')">Admin</button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="Dashboard" class="tabcontent">
            <h2>Dashboard</h2>
            <div class="grid-container">
                <div class="dashboard-card">
                    <h3>Total Products</h3>
                    <div id="totalProducts" class="dashboard-value">0</div>
                </div>
                <div class="dashboard-card">
                    <h3>Total Materials</h3>
                    <div id="totalMaterials" class="dashboard-value">0</div>
                </div>
                <div class="dashboard-card">
                    <h3>Average Product Cost</h3>
                    <div id="avgProductCost" class="dashboard-value">$0.00</div>
                </div>
            </div>
            
            <h3>Product Costs Overview</h3>
            <div id="productCostsOverview">
                <p>No products available.</p>
            </div>
        </div>
        
        <!-- Products Tab -->
        <div id="Products" class="tabcontent">
            <h2>Product Recipes</h2>
            <div id="productList">
                <p>No products available.</p>
            </div>
            
            <div class="form-group">
                <h3>Calculate Individual Product Cost</h3>
                <select id="productSelector">
                    <option value="">Select a product</option>
                </select>
                <div id="productCostResult"></div>
            </div>
            
            <div class="form-group">
                <button onclick="exportProducts()">Export Products to CSV</button>
            </div>
        </div>
        
        <!-- Materials Tab -->
        <div id="Materials" class="tabcontent">
            <h2>Materials Database</h2>
            <div id="materialsList">
                <p>No materials available.</p>
            </div>
            
            <div class="form-group">
                <button onclick="exportMaterials()">Export Materials to CSV</button>
            </div>
        </div>
        
        <!-- Admin Tab -->
        <div id="Admin" class="tabcontent">
            <h2>Administration</h2>
            
            <div class="form-group">
                <h3>Add New Material</h3>
                <input type="text" id="newMaterialName" placeholder="Material Name">
                <input type="number" id="newQtyPerPack" placeholder="Quantity Per Pack">
                <input type="number" id="newTotalAmount" placeholder="Total Amount">
                <button onclick="addNewMaterial()" id="addMaterialBtn">Add Material</button>
            </div>
            
            <div class="form-group">
                <h3>Add New Product</h3>
                <input type="text" id="newProductName" placeholder="Product Name">
                
                <div class="material-selection">
                    <select id="newMaterial1">
                        <option value="NONE">Select Material 1</option>
                    </select>
                    <input type="number" id="newQuantity1" placeholder="Quantity">
                </div>
                
                <div class="material-selection">
                    <select id="newMaterial2">
                        <option value="NONE">Select Material 2</option>
                    </select>
                    <input type="number" id="newQuantity2" placeholder="Quantity">
                </div>
                
                <div class="material-selection">
                    <select id="newMaterial3">
                        <option value="NONE">Select Material 3</option>
                    </select>
                    <input type="number" id="newQuantity3" placeholder="Quantity">
                </div>
                
                <div class="material-selection">
                    <select id="newMaterial4">
                        <option value="NONE">Select Material 4</option>
                    </select>
                    <input type="number" id="newQuantity4" placeholder="Quantity">
                </div>
                
                <div class="material-selection">
                    <select id="newMaterial5">
                        <option value="NONE">Select Material 5</option>
                    </select>
                    <input type="number" id="newQuantity5" placeholder="Quantity">
                </div>
                
                <button onclick="addNewProduct()" id="addProductBtn">Add Product</button>
            </div>
            
            <div class="form-group">
                <h3>Import/Export Data</h3>
                
                <div class="file-input">
                    <label for="productUpload">Import Products:</label>
                    <input type="file" id="productUpload" accept=".csv">
                    <button onclick="uploadProductsCSV()">Upload</button>
                </div>
                
                <div class="file-input">
                    <label for="materialUpload">Import Materials:</label>
                    <input type="file" id="materialUpload" accept=".csv">
                    <button onclick="uploadMaterialsCSV()">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let materials = [];
        let productRecipes = [];
        let editingProductIndex = -1;
        let editingMaterialIndex = -1;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Load data from localStorage
            loadData();
            
            // Set up event listeners
            document.getElementById('productSelector').addEventListener('change', calculateProductCost);
            
            // Open default tab
            document.getElementById('defaultOpen').click();
        });
        
        // Tab navigation function
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            
            tabcontent = document.getElementsByClassName('tabcontent');
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = 'none';
            }
            
            tablinks = document.getElementsByClassName('tablinks');
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(' active', '');
            }
            
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.className += ' active';
        }
        
        // Load data from localStorage
        function loadData() {
            // Load materials
            const storedMaterials = localStorage.getItem('materials');
            if (storedMaterials) {
                materials = JSON.parse(storedMaterials);
            } else {
                // Initialize with "NONE" placeholder
                materials = [{ name: "NONE", qtyPerPack: 0, totalAmount: 0, costPerPiece: 0 }];
                localStorage.setItem('materials', JSON.stringify(materials));
            }
            
            // Load product recipes
            const storedProductRecipes = localStorage.getItem('productRecipes');
            if (storedProductRecipes) {
                productRecipes = JSON.parse(storedProductRecipes);
            } else {
                productRecipes = [];
                localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
            }
            
            // Update UI
            loadMaterialsDatabase();
            loadMaterialOptions();
            loadProductOptions();
            loadProductRecipes();
            updateDashboard();
        }
        
        // Load materials database table
        function loadMaterialsDatabase() {
            const materialsList = document.getElementById('materialsList');
            
            if (materials.length <= 1) { // Only the "NONE" placeholder
                materialsList.innerHTML = '<p>No materials available.</p>';
                return;
            }
            
            let tableHTML = `
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Qty Per Pack</th>
                        <th>Total Amount</th>
                        <th>Cost Per Piece</th>
                        <th>Actions</th>
                    </tr>
            `;
            
            for (let i = 0; i < materials.length; i++) {
                const material = materials[i];
                
                // Skip the "NONE" placeholder
                if (material.name === "NONE") continue;
                
                tableHTML += `
                    <tr>
                        <td>${material.name}</td>
                        <td>${material.qtyPerPack}</td>
                        <td>$${material.totalAmount.toFixed(2)}</td>
                        <td>$${material.costPerPiece.toFixed(4)}</td>
                        <td>
                            <button onclick="editMaterial(${i})">Edit</button>
                            <button onclick="deleteMaterial(${i})">Delete</button>
                        </td>
                    </tr>
                `;
            }
            
            tableHTML += '</table>';
            materialsList.innerHTML = tableHTML;
        }
        
        // Load material options for select dropdowns
        function loadMaterialOptions() {
            const selects = [
                document.getElementById('newMaterial1'),
                document.getElementById('newMaterial2'),
                document.getElementById('newMaterial3'),
                document.getElementById('newMaterial4'),
                document.getElementById('newMaterial5')
            ];
            
            selects.forEach(select => {
                if (!select) return;
                
                // Save current selection
                const currentValue = select.value;
                
                // Clear options
                select.innerHTML = '<option value="NONE">Select Material</option>';
                
                // Add materials
                materials.forEach(material => {
                    if (material.name === "NONE") return;
                    
                    const option = document.createElement('option');
                    option.value = material.name;
                    option.textContent = material.name;
                    select.appendChild(option);
                });
                
                // Restore selection if possible
                if (materials.some(m => m.name === currentValue)) {
                    select.value = currentValue;
                }
            });
        }
        
        // Load product recipes table
        function loadProductRecipes() {
            const productList = document.getElementById('productList');
            
            if (productRecipes.length === 0) {
                productList.innerHTML = '<p>No products available.</p>';
                return;
            }
            
            let tableHTML = `
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Materials</th>
                        <th>Total Cost</th>
                        <th>Actions</th>
                    </tr>
            `;
            
            for (let i = 0; i < productRecipes.length; i++) {
                const product = productRecipes[i];
                
                let materialsText = '';
                for (let j = 0; j < product.materials.length; j++) {
                    if (product.materials[j] !== 'NONE' && product.quantities[j]) {
                        materialsText += `${product.materials[j]} (${product.quantities[j]}), `;
                    }
                }
                materialsText = materialsText.slice(0, -2);
                
                tableHTML += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${materialsText}</td>
                        <td>$${product.totalCost.toFixed(2)}</td>
                        <td>
                            <button onclick="editProduct(${i})">Edit</button>
                            <button onclick="deleteProduct(${i})">Delete</button>
                        </td>
                    </tr>
                `;
            }
            
            tableHTML += '</table>';
            productList.innerHTML = tableHTML;
        }
        
        // Load product options for the product selector
        function loadProductOptions() {
            const productSelector = document.getElementById('productSelector');
            
            // Save current selection
            const currentValue = productSelector.value;
            
            // Clear options
            productSelector.innerHTML = '<option value="">Select a product</option>';
            
            // Add products
            productRecipes.forEach(product => {
                const option = document.createElement('option');
                option.value = product.name;
                option.textContent = product.name;
                productSelector.appendChild(option);
            });
            
            // Restore selection if possible
            if (productRecipes.some(p => p.name === currentValue)) {
                productSelector.value = currentValue;
            }
        }
        
        // Update dashboard
        function updateDashboard() {
            document.getElementById('totalProducts').textContent = productRecipes.length;
            document.getElementById('totalMaterials').textContent = materials.length - 1; // Exclude "NONE"
            
            // Calculate average product cost
            let totalCost = 0;
            if (productRecipes.length > 0) {
                productRecipes.forEach(product => {
                    totalCost += product.totalCost;
                });
                document.getElementById('avgProductCost').textContent = '$' + (totalCost / productRecipes.length).toFixed(2);
            } else {
                document.getElementById('avgProductCost').textContent = '$0.00';
            }
            
            // Update product costs overview
            const productCostsOverview = document.getElementById('productCostsOverview');
            
            if (productRecipes.length === 0) {
                productCostsOverview.innerHTML = '<p>No products available.</p>';
                return;
            }
            
            let tableHTML = `
                <table>
                    <tr>
                        <th>Product</th>
                        <th>Cost</th>
                    </tr>
            `;
            
            // Sort products by cost (highest to lowest)
            const sortedProducts = [...productRecipes].sort((a, b) => b.totalCost - a.totalCost);
            
            for (const product of sortedProducts) {
                tableHTML += `
                    <tr>
                        <td>${product.name}</td>
                        <td>$${product.totalCost.toFixed(2)}</td>
                    </tr>
                `;
            }
            
            tableHTML += '</table>';
            productCostsOverview.innerHTML = tableHTML;
        }
        
        // Calculate selected product cost
        function calculateProductCost() {
            const productName = document.getElementById('productSelector').value;
            const resultDiv = document.getElementById('productCostResult');
            
            if (!productName) {
                resultDiv.innerHTML = '';
                return;
            }
            
            const product = productRecipes.find(p => p.name === productName);
            
            if (!product) {
                resultDiv.innerHTML = '<p>Product not found</p>';
                return;
            }
            
            let materialsHTML = '<h4>Materials:</h4><ul>';
            
            for (let i = 0; i < product.materials.length; i++) {
                if (product.materials[i] !== 'NONE' && product.quantities[i]) {
                    const material = materials.find(m => m.name === product.materials[i]);
                    
                    if (material) {
                        const materialCost = material.costPerPiece * parseFloat(product.quantities[i]);
                        materialsHTML += `<li>${material.name} (${product.quantities[i]}) - $${materialCost.toFixed(2)}</li>`;
                    } else {
                        materialsHTML += `<li>${product.materials[i]} (${product.quantities[i]}) - Material not found</li>`;
                    }
                }
            }
            
            materialsHTML += '</ul>';
            
            resultDiv.innerHTML = `
                <div class="dashboard-card">
                    <h3>${product.name}</h3>
                    ${materialsHTML}
                    <h4>Total Cost: $${product.totalCost.toFixed(2)}</h4>
                </div>
            `;
        }
        
        // Edit a product
        function editProduct(index) {
            const product = productRecipes[index];
            editingProductIndex = index;
            
            // Populate form
            document.getElementById('newProductName').value = product.name;
            
            for (let i = 0; i < 5; i++) {
                if (i < product.materials.length) {
                    document.getElementById(`newMaterial${i+1}`).value = product.materials[i] || 'NONE';
                    document.getElementById(`newQuantity${i+1}`).value = product.quantities[i] || '';
                } else {
                    document.getElementById(`newMaterial${i+1}`).value = 'NONE';
                    document.getElementById(`newQuantity${i+1}`).value = '';
                }
            }
            
            // Change button text
            document.getElementById('addProductBtn').textContent = 'Update Product';
            
            // Switch to Admin tab
            document.querySelector('.tablinks[onclick*="Admin"]').click();
        }
        
        // Delete a product
        function deleteProduct(index) {
            if (confirm('Are you sure you want to delete this product?')) {
                productRecipes.splice(index, 1);
                
                // Save to localStorage
                localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
                
                // Update UI
                loadProductOptions();
                loadProductRecipes();
                updateDashboard();
            }
        }
        
        // Edit a material
        function editMaterial(index) {
            const material = materials[index];
            editingMaterialIndex = index;
            
            // Gather updated information
            const name = prompt('Material Name:', material.name);
            if (!name) return;
            
            const qtyPerPack = parseInt(prompt('Quantity Per Pack:', material.qtyPerPack));
            if (isNaN(qtyPerPack) || qtyPerPack <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            const totalAmount = parseFloat(prompt('Total Amount:', material.totalAmount));
            if (isNaN(totalAmount) || totalAmount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            // Calculate cost per piece
            const costPerPiece = totalAmount / qtyPerPack;
            
            // Store original name for updating product recipes
            const originalName = material.name;
            
            // Update material
            material.name = name;
            material.qtyPerPack = qtyPerPack;
            material.totalAmount = totalAmount;
            material.costPerPiece = costPerPiece;
            
            // Update product recipes if name changed
            if (originalName !== name) {
                productRecipes.forEach(product => {
                    for (let i = 0; i < product.materials.length; i++) {
                        if (product.materials[i] === originalName) {
                            product.materials[i] = name;
                        }
                    }
                });
            }
            
            // Update product costs
            updateProductCosts();
            
            // Save to localStorage
            localStorage.setItem('materials', JSON.stringify(materials));
            localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
            
            // Update UI
            loadMaterialsDatabase();
            loadMaterialOptions();
            loadProductRecipes();
            updateDashboard();
            
            editingMaterialIndex = -1;
        }
        
        // Delete a material
        function deleteMaterial(index) {
            const material = materials[index];
            
            // Check if material is used in any product
            const isUsed = productRecipes.some(product => 
                product.materials.includes(material.name)
            );
            
            if (isUsed) {
                alert('This material is used in one or more products. Please update or delete those products first.');
                return;
            }
            
            if (confirm('Are you sure you want to delete this material?')) {
                materials.splice(index, 1);
                
                // Save to localStorage
                localStorage.setItem('materials', JSON.stringify(materials));
                
                // Update UI
                loadMaterialsDatabase();
                loadMaterialOptions();
                updateDashboard();
            }
        }
        
        // Update product costs after material changes
        function updateProductCosts() {
            productRecipes.forEach(product => {
                let totalCost = 0;
                
                for (let i = 0; i < product.materials.length; i++) {
                    const materialName = product.materials[i];
                    const quantity = product.quantities[i];
                    
                    if (materialName !== 'NONE' && quantity) {
                        const material = materials.find(m => m.name === materialName);
                        if (material) {
                            totalCost += material.costPerPiece * parseFloat(quantity);
                        }
                    }
                }
                
                product.totalCost = totalCost;
            });
        }
        
        // Add new product
        function addNewProduct() {
            const productName = document.getElementById('newProductName').value.trim();
            
            if (!productName) {
                alert('Please enter a product name');
                return;
            }
            
            // Get materials and quantities
            const material1 = document.getElementById('newMaterial1').value;
            const quantity1 = document.getElementById('newQuantity1').value;
            const material2 = document.getElementById('newMaterial2').value;
            const quantity2 = document.getElementById('newQuantity2').value;
            const material3 = document.getElementById('newMaterial3').value;
            const quantity3 = document.getElementById('newQuantity3').value;
            const material4 = document.getElementById('newMaterial4').value;
            const quantity4 = document.getElementById('newQuantity4').value;
            const material5 = document.getElementById('newMaterial5').value;
            const quantity5 = document.getElementById('newQuantity5').value;
            
            // Validate at least one material
            if ((material1 === 'NONE' || !quantity1) && 
                (material2 === 'NONE' || !quantity2) && 
                (material3 === 'NONE' || !quantity3) &&
                (material4 === 'NONE' || !quantity4) &&
                (material5 === 'NONE' || !quantity5)) {
                alert('Please add at least one material with a quantity');
                return;
            }
            
            // Calculate total cost
            let totalCost = 0;
            
            if (material1 !== 'NONE' && quantity1) {
                const material = materials.find(m => m.name === material1);
                if (material) {
                    totalCost += material.costPerPiece * parseFloat(quantity1);
                }
            }
            
            if (material2 !== 'NONE' && quantity2) {
                const material = materials.find(m => m.name === material2);
                if (material) {
                    totalCost += material.costPerPiece * parseFloat(quantity2);
                }
            }
            
            if (material3 !== 'NONE' && quantity3) {
                const material = materials.find(m => m.name === material3);
                if (material) {
                    totalCost += material.costPerPiece * parseFloat(quantity3);
                }
            }
            
            if (material4 !== 'NONE' && quantity4) {
                const material = materials.find(m => m.name === material4);
                if (material) {
                    totalCost += material.costPerPiece * parseFloat(quantity4);
                }
            }
            
            if (material5 !== 'NONE' && quantity5) {
                const material = materials.find(m => m.name === material5);
                if (material) {
                    totalCost += material.costPerPiece * parseFloat(quantity5);
                }
            }
            
            // Create new product or update existing
            const newProduct = {
                name: productName,
                materials: [material1, material2, material3, material4, material5],
                quantities: [quantity1, quantity2, quantity3, quantity4, quantity5],
                totalCost: totalCost
            };
            
            if (editingProductIndex >= 0) {
                // Update existing product
                productRecipes[editingProductIndex] = newProduct;
                editingProductIndex = -1;
                document.getElementById('addProductBtn').textContent = 'Add Product';
            } else {
                // Check if product already exists
                if (productRecipes.some(p => p.name === productName)) {
                    alert('A product with this name already exists');
                    return;
                }
                
                // Add new product
                productRecipes.push(newProduct);
            }
            
            // Save to localStorage
            localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
            
            // Update UI
            loadProductOptions();
            loadProductRecipes();
            updateDashboard();
            
            // Clear form
            document.getElementById('newProductName').value = '';
            document.getElementById('newMaterial1').value = 'NONE';
            document.getElementById('newQuantity1').value = '';
            document.getElementById('newMaterial2').value = 'NONE';
            document.getElementById('newQuantity2').value = '';
            document.getElementById('newMaterial3').value = 'NONE';
            document.getElementById('newQuantity3').value = '';
            document.getElementById('newMaterial4').value = 'NONE';
            document.getElementById('newQuantity4').value = '';
            document.getElementById('newMaterial5').value = 'NONE';
            document.getElementById('newQuantity5').value = '';
            
            alert(editingProductIndex >= 0 ? 'Product updated successfully!' : 'Product added successfully!');
        }

        // Add new material
        function addNewMaterial() {
            const name = document.getElementById('newMaterialName').value.trim();
            
            if (!name) {
                alert('Please enter a material name');
                return;
            }
            
            // Check if material already exists
            if (materials.some(m => m.name === name)) {
                alert('A material with this name already exists');
                return;
            }
            
            const qtyPerPack = parseInt(document.getElementById('newQtyPerPack').value) || 0;
            const totalAmount = parseFloat(document.getElementById('newTotalAmount').value) || 0;
            
            if (qtyPerPack <= 0 || totalAmount <= 0) {
                alert('Please enter valid quantity and amount values');
                return;
            }
            
            // Calculate cost per piece
            const costPerPiece = totalAmount / qtyPerPack;
            
            // Create new material
            const newMaterial = {
                name: name,
                qtyPerPack: qtyPerPack,
                totalAmount: totalAmount,
                costPerPiece: costPerPiece
            };
            
            materials.push(newMaterial);
            
            // Save to localStorage
            localStorage.setItem('materials', JSON.stringify(materials));
            
            // Update UI
            loadMaterialsDatabase();
            loadMaterialOptions();
            
            // Clear form
            document.getElementById('newMaterialName').value = '';
            document.getElementById('newQtyPerPack').value = '';
            document.getElementById('newTotalAmount').value = '';
            alert('Material added successfully!');
        }
        
        // Export products to CSV
        function exportProducts() {
            if (productRecipes.length === 0) {
                alert('No products to export');
                return;
            }
            
            let csvContent = 'Name,Material1,Quantity1,Material2,Quantity2,Material3,Quantity3,Material4,Quantity4,Material5,Quantity5,TotalCost\n';
            
            productRecipes.forEach(product => {
                let row = [
                    product.name,
                    product.materials[0] || 'NONE', product.quantities[0] || '',
                    product.materials[1] || 'NONE', product.quantities[1] || '',
                    product.materials[2] || 'NONE', product.quantities[2] || '',
                    product.materials[3] || 'NONE', product.quantities[3] || '',
                    product.materials[4] || 'NONE', product.quantities[4] || '',
                    product.totalCost.toFixed(2)
                ];
                
                // Escape commas and quotes in fields
                row = row.map(field => {
                    // Convert to string if not already
                    let str = String(field);
                    // If the field contains commas or quotes, wrap in quotes
                    if (str.includes(',') || str.includes('"')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                });
                
                csvContent += row.join(',') + '\n';
            });
            
            downloadCSV(csvContent, 'product_recipes.csv');
        }
        
        // Export materials to CSV
        function exportMaterials() {
            if (materials.length <= 1) { // Only the "NONE" placeholder
                alert('No materials to export');
                return;
            }
            
            let csvContent = 'Name,QuantityPerPack,TotalAmount,CostPerPiece\n';
            
            materials.forEach(material => {
                // Skip the "NONE" placeholder
                if (material.name === "NONE") return;
                
                let row = [
                    material.name,
                    material.qtyPerPack,
                    material.totalAmount.toFixed(2),
                    material.costPerPiece.toFixed(4)
                ];
                
                // Escape commas and quotes in fields
                row = row.map(field => {
                    // Convert to string if not already
                    let str = String(field);
                    // If the field contains commas or quotes, wrap in quotes
                    if (str.includes(',') || str.includes('"')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                });
                
                csvContent += row.join(',') + '\n';
            });
            
            downloadCSV(csvContent, 'materials.csv');
        }
        
        // Helper function to download CSV
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            // Create a URL for the blob
            const url = URL.createObjectURL(blob);
            
            // Set up the download link
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            // Add the link to the document
            document.body.appendChild(link);
            
            // Click the download link
            link.click();
            
            // Clean up
            document.body.removeChild(link);
        }
        
        // Upload products CSV file
        function uploadProductsCSV() {
            const fileInput = document.getElementById('productUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to upload');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    const lines = csvData.split('\n');
                    
                    // Skip header line
                    if (lines.length < 2) {
                        throw new Error('Invalid CSV format');
                    }
                    
                    // Clear existing products
                    if (confirm('This will replace all existing products. Continue?')) {
                        productRecipes = [];
                        
                        // Parse CSV lines (starting from line 1 to skip the header)
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue; // Skip empty lines
                            
                            const values = parseCSVLine(lines[i]);
                            
                            if (values.length < 12) {
                                console.warn(`Skipping line ${i}: invalid format`);
                                continue;
                            }
                            
                            const product = {
                                name: values[0],
                                materials: [
                                    values[1] || 'NONE',
                                    values[3] || 'NONE',
                                    values[5] || 'NONE',
                                    values[7] || 'NONE',
                                    values[9] || 'NONE'
                                ],
                                quantities: [
                                    values[2] || '',
                                    values[4] || '',
                                    values[6] || '',
                                    values[8] || '',
                                    values[10] || ''
                                ],
                                totalCost: parseFloat(values[11]) || 0
                            };
                            
                            productRecipes.push(product);
                        }
                        
                        // Save to localStorage
                        localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
                        
                        // Update UI
                        loadProductOptions();
                        loadProductRecipes();
                        updateDashboard();
                        
                        alert('Products imported successfully!');
                        fileInput.value = '';
                    }
                } catch (error) {
                    alert('Error importing products: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }
        
        // Upload materials CSV file
        function uploadMaterialsCSV() {
            const fileInput = document.getElementById('materialUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to upload');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    const lines = csvData.split('\n');
                    
                    // Skip header line
                    if (lines.length < 2) {
                        throw new Error('Invalid CSV format');
                    }
                    
                    // Keep the "NONE" placeholder but clear other materials
                    if (confirm('This will replace all existing materials. Continue?')) {
                        // Keep only the "NONE" placeholder
                        materials = materials.filter(m => m.name === "NONE");
                        
                        // Parse CSV lines (starting from line 1 to skip the header)
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue; // Skip empty lines
                            
                            const values = parseCSVLine(lines[i]);
                            
                            if (values.length < 4) {
                                console.warn(`Skipping line ${i}: invalid format`);
                                continue;
                            }
                            
                            const material = {
                                name: values[0],
                                qtyPerPack: parseInt(values[1]) || 0,
                                totalAmount: parseFloat(values[2]) || 0,
                                costPerPiece: parseFloat(values[3]) || 0
                            };
                            
                            // Skip if name is empty or "NONE"
                            if (!material.name || material.name === "NONE") continue;
                            
                            // Add the material
                            materials.push(material);
                        }
                        
                        // Save to localStorage
                        localStorage.setItem('materials', JSON.stringify(materials));
                        
                        // Update UI
                        loadMaterialsDatabase();
                        loadMaterialOptions();
                        updateProductCosts();
                        
                        // Save updated product costs
                        localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
                        
                        loadProductRecipes();
                        updateDashboard();
                        
                        alert('Materials imported successfully!');
                        fileInput.value = '';
                    }
                } catch (error) {
                    alert('Error importing materials: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }
        
        // Helper function to parse CSV line correctly handling quotes
        function parseCSVLine(line) {
            const result = [];
            let inQuotes = false;
            let currentValue = '';
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    // Check for escaped quote (two quotes in a row)
                    if (i + 1 < line.length && line[i + 1] === '"') {
                        currentValue += '"';
                        i++; // Skip the next quote
                    } else {
                        // Toggle quote mode
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    result.push(currentValue);
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            
            // Add the last field
            result.push(currentValue);
            
            return result;
        }
    </script>
</body>
</html>
