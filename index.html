<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Material Cost Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .panel {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #f8f8f8;
            border-color: #ddd;
            border-bottom: 1px solid #f8f8f8;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
            padding: 15px 0;
        }
        .tab-content.active {
            display: block;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
        }
        .profit {
            color: green;
            font-weight: bold;
        }
        .loss {
            color: red;
            font-weight: bold;
        }
        .edit-btn {
            background-color: #2196F3;
            margin-right: 5px;
        }
        .delete-btn {
            background-color: #f44336;
        }
        .button-group {
            margin-top: 10px;
        }
        .file-upload {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Product Material Cost Calculator</h1>
        
        <div class="tabs">
            <div class="tab active" data-tab="calculator">Calculator</div>
            <div class="tab" data-tab="dashboard">Dashboard</div>
            <div class="tab" data-tab="materials">Materials</div>
            <div class="tab" data-tab="recipes">Product Recipes</div>
            <div class="tab" data-tab="admin">Admin</div>
        </div>
        
        <!-- Calculator Tab -->
        <div id="calculator" class="tab-content active">
            <div class="panel">
                <h2>Calculate Product Cost</h2>
                
                <div class="input-group">
                    <label for="productSelect">Select Product</label>
                    <select id="productSelect"></select>
                </div>
                
                <h3>Materials</h3>
                <table id="materialsTable">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Quantity</th>
                            <th>Cost per Piece</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Materials will be populated here -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>Total Material Cost:</strong></td>
                            <td id="totalCost">$0.00</td>
                        </tr>
                    </tfoot>
                </table>
                
                <h3>Profit Analysis</h3>
                <div class="input-group">
                    <label for="sellingPrice">Selling Price ($)</label>
                    <input type="number" id="sellingPrice" step="0.01" min="0">
                </div>
                
                <div class="input-group">
                    <label for="profit">Profit ($)</label>
                    <input type="text" id="profit" readonly>
                </div>
                
                <div class="input-group">
                    <label for="profitMargin">Profit Margin (%)</label>
                    <input type="text" id="profitMargin" readonly>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <h2>Product Dashboard</h2>
            <div class="grid" id="productGrid">
                <!-- Products will be populated here -->
            </div>
        </div>
        
        <!-- Materials Tab -->
        <div id="materials" class="tab-content">
            <h2>Materials Database</h2>
            <table id="materialsDatabase">
                <thead>
                    <tr>
                        <th>Material Name</th>
                        <th>Quantity per Pack</th>
                        <th>Total Amount ($)</th>
                        <th>Cost per Piece ($)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Materials will be populated here -->
                </tbody>
            </table>
        </div>
        
        <!-- Product Recipes Tab -->
        <div id="recipes" class="tab-content">
            <h2>Product Recipes</h2>
            <table id="productRecipes">
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Materials</th>
                        <th>Total Cost ($)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Products will be populated here -->
                </tbody>
            </table>
        </div>
        
        <!-- Admin Tab -->
        <div id="admin" class="tab-content">
            <div class="panel">
                <h2>Add New Product</h2>
                <div class="input-group">
                    <label for="newProductName">Product Name</label>
                    <input type="text" id="newProductName" placeholder="Enter product name">
                </div>
                
                <h3>Materials</h3>
                
                <div class="input-group">
                    <label for="newMaterial1">Material 1</label>
                    <select id="newMaterial1"></select>
                </div>
                <div class="input-group">
                    <label for="newQuantity1">Quantity 1</label>
                    <input type="number" id="newQuantity1" min="0" step="1">
                </div>
                
                <div class="input-group">
                    <label for="newMaterial2">Material 2</label>
                    <select id="newMaterial2"></select>
                </div>
                <div class="input-group">
                    <label for="newQuantity2">Quantity 2</label>
                    <input type="number" id="newQuantity2" min="0" step="1">
                </div>
                
                <div class="input-group">
                    <label for="newMaterial3">Material 3</label>
                    <select id="newMaterial3"></select>
                </div>
                <div class="input-group">
                    <label for="newQuantity3">Quantity 3</label>
                    <input type="number" id="newQuantity3" min="0" step="1">
                </div>
                
                <div class="input-group">
                    <label for="newMaterial4">Material 4</label>
                    <select id="newMaterial4"></select>
                </div>
                <div class="input-group">
                    <label for="newQuantity4">Quantity 4</label>
                    <input type="number" id="newQuantity4" min="0" step="1">
                </div>
                
                <div class="input-group">
                    <label for="newMaterial5">Material 5</label>
                    <select id="newMaterial5"></select>
                </div>
                <div class="input-group">
                    <label for="newQuantity5">Quantity 5</label>
                    <input type="number" id="newQuantity5" min="0" step="1">
                </div>
                
                <button onclick="addNewProduct()">Add Product</button>
            </div>
            
            <div class="panel">
                <h2>Add New Material</h2>
                <div class="input-group">
                    <label for="newMaterialName">Material Name</label>
                    <input type="text" id="newMaterialName" placeholder="Enter material name">
                </div>
                <div class="input-group">
                    <label for="newQtyPerPack">Quantity per Pack</label>
                    <input type="number" id="newQtyPerPack" min="1" step="1">
                </div>
                <div class="input-group">
                    <label for="newTotalAmount">Total Amount ($)</label>
                    <input type="number" id="newTotalAmount" min="0.01" step="0.01">
                </div>
                <button onclick="addNewMaterial()">Add Material</button>
            </div>
            
            <div class="panel">
                <h2>Import/Export Data</h2>
                
                <h3>Products</h3>
                <div class="button-group">
                    <button onclick="exportProducts()">Export Products to CSV</button>
                </div>
                <div class="file-upload">
                    <input type="file" id="productUpload" accept=".csv">
                    <button onclick="uploadProductsCSV()">Upload Products CSV</button>
                </div>
                
                <h3>Materials</h3>
                <div class="button-group">
                    <button onclick="exportMaterials()">Export Materials to CSV</button>
                </div>
                <div class="file-upload">
                    <input type="file" id="materialUpload" accept=".csv">
                    <button onclick="uploadMaterialsCSV()">Upload Materials CSV</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let materials = [];
        let productRecipes = [];
        let editingProductIndex = -1;
        let editingMaterialIndex = -1;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set up tab navigation
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs and tab contents
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Initialize materials if they don't exist
            if (!localStorage.getItem('materials')) {
                materials = [{ name: "NONE", qtyPerPack: 0, totalAmount: 0, costPerPiece: 0 }];
                localStorage.setItem('materials', JSON.stringify(materials));
            } else {
                materials = JSON.parse(localStorage.getItem('materials'));
            }
            
            // Initialize product recipes if they don't exist
            if (!localStorage.getItem('productRecipes')) {
                productRecipes = [];
                localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
            } else {
                productRecipes = JSON.parse(localStorage.getItem('productRecipes'));
            }
            
            // Load UI components
            loadMaterialsDatabase();
            loadProductOptions();
            loadMaterialOptions();
            loadProductRecipes();
            updateDashboard();
            
            // Add event listener for product selection
            document.getElementById('productSelect').addEventListener('change', function() {
                loadProductMaterials();
            });
            
            // Add event listener for selling price
            document.getElementById('sellingPrice').addEventListener('input', function() {
                calculateProfit();
            });
        });
        
        // Load materials database
        function loadMaterialsDatabase() {
            const tbody = document.querySelector('#materialsDatabase tbody');
            tbody.innerHTML = '';
            
            materials.forEach((material, index) => {
                // Skip the "NONE" placeholder
                if (material.name === "NONE") return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${material.name}</td>
                    <td>${material.qtyPerPack}</td>
                    <td>$${material.totalAmount.toFixed(2)}</td>
                    <td>$${material.costPerPiece.toFixed(4)}</td>
                    <td>
                        <button class="edit-btn" onclick="editMaterial(${index})">Edit</button>
                        <button class="delete-btn" onclick="deleteMaterial(${index})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Load product options
        function loadProductOptions() {
            const productSelect = document.getElementById('productSelect');
            productSelect.innerHTML = '<option value="">Select a product</option>';
            
            productRecipes.forEach((product, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = product.name;
                productSelect.appendChild(option);
            });
        }
        
        // Load material options for dropdowns
        function loadMaterialOptions() {
            const dropdowns = [
                'newMaterial1', 'newMaterial2', 'newMaterial3', 'newMaterial4', 'newMaterial5'
            ];
            
            dropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                dropdown.innerHTML = '';
                
                // Add "NONE" option first
                const noneOption = document.createElement('option');
                noneOption.value = "NONE";
                noneOption.textContent = "NONE";
                dropdown.appendChild(noneOption);
                
                // Add all other materials
                materials.forEach(material => {
                    if (material.name === "NONE") return;
                    
                    const option = document.createElement('option');
                    option.value = material.name;
                    option.textContent = material.name;
                    dropdown.appendChild(option);
                });
            });
        }
        
        // Load materials for selected product
        function loadProductMaterials() {
            const productIndex = document.getElementById('productSelect').value;
            
            if (productIndex === "") {
                // Clear the table if no product is selected
                document.querySelector('#materialsTable tbody').innerHTML = '';
                document.getElementById('totalCost').textContent = '$0.00';
                document.getElementById('sellingPrice').value = '';
                document.getElementById('profit').value = '';
                document.getElementById('profitMargin').value = '';
                return;
            }
            
            const product = productRecipes[productIndex];
            const tbody = document.querySelector('#materialsTable tbody');
            tbody.innerHTML = '';
            
            let totalCost = 0;
            
            // Loop through the materials array (up to 5 materials)
            for (let i = 0; i < product.materials.length; i++) {
                const materialName = product.materials[i];
                const quantity = product.quantities[i];
                
                // Skip if material is "NONE" or quantity is empty
                if (materialName === "NONE" || !quantity) continue;
                
                // Find the material in the materials array
                const material = materials.find(m => m.name === materialName);
                
                if (material) {
                    const subtotal = material.costPerPiece * quantity;
                    totalCost += subtotal;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${material.name}</td>
                        <td>${quantity}</td>
                        <td>$${material.costPerPiece.toFixed(4)}</td>
                        <td>$${subtotal.toFixed(2)}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            document.getElementById('totalCost').textContent = `$${totalCost.toFixed(2)}`;
            
            // Update the product's total cost
            product.totalCost = totalCost;
            localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
            
            // Clear selling price input and profit fields
            document.getElementById('sellingPrice').value = '';
            document.getElementById('profit').value = '';
            document.getElementById('profitMargin').value = '';
        }
        
        // Calculate profit
        function calculateProfit() {
            const productIndex = document.getElementById('productSelect').value;
            
            if (productIndex === "") return;
            
            const totalCost = productRecipes[productIndex].totalCost;
            const sellingPrice = parseFloat(document.getElementById('sellingPrice').value) || 0;
            
            const profit = sellingPrice - totalCost;
            const profitMargin = sellingPrice > 0 ? (profit / sellingPrice) * 100 : 0;
            
            document.getElementById('profit').value = `$${profit.toFixed(2)}`;
            document.getElementById('profitMargin').value = `${profitMargin.toFixed(2)}%`;
            
            // Add profit/loss class
            const profitField = document.getElementById('profit');
            if (profit > 0) {
                profitField.classList.add('profit');
                profitField.classList.remove('loss');
            } else if (profit < 0) {
                profitField.classList.add('loss');
                profitField.classList.remove('profit');
            } else {
                profitField.classList.remove('profit');
                profitField.classList.remove('loss');
            }
        }
        
        // Load product recipes
        function loadProductRecipes() {
            const tbody = document.querySelector('#productRecipes tbody');
            tbody.innerHTML = '';
            
            productRecipes.forEach((product, index) => {
                const row = document.createElement('tr');
                
                // Create a string to display materials and quantities
                let materialsText = '';
                for (let i = 0; i < product.materials.length; i++) {
                    if (product.materials[i] !== "NONE" && product.quantities[i]) {
                        materialsText += `${product.materials[i]}: ${product.quantities[i]}<br>`;
                    }
                }
                
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${materialsText}</td>
                    <td>$${product.totalCost.toFixed(2)}</td>
                    <td>
                        <button class="edit-btn" onclick="editProduct(${index})">Edit</button>
                        <button class="delete-btn" onclick="deleteProduct(${index})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Update dashboard
        function updateDashboard() {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';
            
            productRecipes.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                
                // Create a string to display materials and quantities
                let materialsText = '';
                for (let i = 0; i < product.materials.length; i++) {
                    if (product.materials[i] !== "NONE" && product.quantities[i]) {
                        materialsText += `${product.materials[i]}: ${product.quantities[i]}<br>`;
                    }
                }
                
                card.innerHTML = `
                    <h3>${product.name}</h3>
                    <p><strong>Materials:</strong><br>${materialsText}</p>
                    <p><strong>Total Cost:</strong> $${product.totalCost.toFixed(2)}</p>
                `;
                grid.appendChild(card);
            });
        }
        
        // Edit material
        function editMaterial(index) {
            const material = materials[index];
            
            // Create edit form
            const nameInput = prompt('Material Name:', material.name);
            if (!nameInput) return;
            
            const qtyPerPackInput = prompt('Quantity per Pack:', material.qtyPerPack);
            if (!qtyPerPackInput) return;
            
            const totalAmountInput = prompt('Total Amount ($):', material.totalAmount);
            if (!totalAmountInput) return;
            
            // Update material
            const qtyPerPack = parseInt(qtyPerPackInput) || 0;
            const totalAmount = parseFloat(totalAmountInput) || 0;
            
            if (qtyPerPack <= 0 || totalAmount <= 0) {
                alert('Please enter valid quantity and amount values');
                return;
            }
            
            // Calculate cost per piece
            const costPerPiece = totalAmount / qtyPerPack;
            
            // Update material object
            material.name = nameInput;
            material.qtyPerPack = qtyPerPack;
            material.totalAmount = totalAmount;
            material.costPerPiece = costPerPiece;
            
            // Save to localStorage
            localStorage.setItem('materials', JSON.stringify(materials));
            
            // Update UI
            loadMaterialsDatabase();
            loadMaterialOptions();
            
            // Update product costs - recalculate for all products using this material
            updateProductCosts();
        }
        
        // Delete material
        function deleteMaterial(index) {
            if (!confirm('Are you sure you want to delete this material?')) {
                return;
            }
            
            const materialName = materials[index].name;
            
            // Check if any products use this material
            const usedInProducts = productRecipes.some(product => 
                product.materials.includes(materialName)
            );
            
            if (usedInProducts) {
                alert('Cannot delete this material as it is used in one or more products.');
                return;
            }
            
            // Remove the material
            materials.splice(index, 1);
            
            // Save to localStorage
            localStorage.setItem('materials', JSON.stringify(materials));
            
            // Update UI
            loadMaterialsDatabase();
            loadMaterialOptions();
        }
        
        // Edit product
        function editProduct(index) {
            const product = productRecipes[index];
            
            // Store the index of the product being edited
            editingProductIndex = index;
            
            // Populate the form with current values
            document.getElementById('newProductName').value = product.name;
            
            // Fill in material dropdowns and quantities (up to 5 materials)
            for (let i = 0; i < 5; i++) {
                const materialDropdown = document.getElementById(`newMaterial${i+1}`);
                const quantityInput = document.getElementById(`newQuantity${i+1}`);
                
                if (i < product.materials.length) {
                    // Set the material dropdown value
                    const materialName = product.materials[i] || "NONE";
                    
                    // Find the option and set it as selected
                    for (let j = 0; j < materialDropdown.options.length; j++) {
                        if (materialDropdown.options[j].value === materialName) {
                            materialDropdown.selectedIndex = j;
                            break;
                        }
                    }
                    
                    // Set the quantity value
                    quantityInput.value = product.quantities[i] || "";
                } else {
                    // Clear any extra fields
                    materialDropdown.value = "NONE";
                    quantityInput.value = "";
                }
            }
            
            // Set Tab to Admin
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="admin"]').classList.add('active');
            document.getElementById('admin').classList.add('active');
            
            // Change the button text
            const addButton = document.querySelector('button[onclick="addNewProduct()"]');
            addButton.textContent = "Update Product";
            addButton.onclick = function() {
                updateProduct();
            };
        }
        
        // Update product
        function updateProduct() {
            const productName = document.getElementById('newProductName').value.trim();
            
            if (!productName) {
                alert('Please enter a product name');
                return;
            }
            
            // Get materials and quantities
            const materials = [];
            const quantities = [];
            
            for (let i = 1; i <= 5; i++) {
                const material = document.getElementById(`newMaterial${i}`).value;
                const quantity = document.getElementById(`newQuantity${i}`).value;
                
                materials.push(material);
                quantities.push(quantity);
            }
            
            // Calculate total cost
            let totalCost = 0;
            
            for (let i = 0; i < materials.length; i++) {
                if (materials[i] !== "NONE" && quantities[i]) {
                    const material = window.materials.find(m => m.name === materials[i]);
                    if (material) {
                        totalCost += material.costPerPiece * parseFloat(quantities[i]);
                    }
                }
            }
            
            // Update product
            productRecipes[editingProductIndex] = {
                name: productName,
                materials: materials,
                quantities: quantities,
                totalCost: totalCost
            };
            
            // Save to localStorage
            localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
            
            // Update UI
            loadProductOptions();
            loadProductRecipes();
            updateDashboard();
            
            // Reset form
            document.getElementById('newProductName').value = '';
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`newMaterial${i}`).value = 'NONE';
                document.getElementById(`newQuantity${i}`).value = '';
            }
            
            // Reset button
            const addButton = document.querySelector('button[onclick="updateProduct()"]');
            addButton.textContent = "Add Product";
            addButton.onclick = function() {
                addNewProduct();
            };
            
            // Reset editing index
            editingProductIndex = -1;
            
            alert('Product updated successfully!');
        }
        
        // Delete product
        function deleteProduct(index) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }
            
            // Remove the product
            productRecipes.splice(index, 1);
            
            // Save to localStorage
            localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
            
            // Update UI
            loadProductOptions();
            loadProductRecipes();
            updateDashboard();
        }
        
        // Update product costs when a material changes
        function updateProductCosts() {
            productRecipes.forEach(product => {
                let totalCost = 0;
                
                for (let i = 0; i < product.materials.length; i++) {
                    if (product.materials[i] !== "NONE" && product.quantities[i]) {
                        const material = materials.find(m => m.name === product.materials[i]);
                        if (material) {
                            totalCost += material.costPerPiece * parseFloat(product.quantities[i]);
                        }
                    }
                }
                
                product.totalCost = totalCost;
            });
            
            // Save to localStorage
            localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
            
            // Update UI
            loadProductRecipes();
            updateDashboard();
        }
        
        // Add new product
        function addNewProduct() {
            // If in edit mode, call updateProduct instead
            if (editingProductIndex !== -1) {
                updateProduct();
                return;
            }
            
            const productName = document.getElementById('newProductName').value.trim();
            
            if (!productName) {
                alert('Please enter a product name');
                return;
            }
            
            // Check if product already exists
            if (productRecipes.some(p => p.name === productName)) {
                alert('A product with this name already exists');
                return;
            }
            
            // Get materials and quantities
            const material1 = document.getElementById('newMaterial1').value;
            const quantity1 = document.getElementById('newQuantity1').value;
            const material2 = document.getElementById('newMaterial2').value;
            const quantity2 = document.getElementById('newQuantity2').value;
            const material3 = document.getElementById('newMaterial3').value;
            const quantity3 = document.getElementById('newQuantity3').value;
            const material4 = document.getElementById('newMaterial4').value;
            const quantity4 = document.getElementById('newQuantity4').value;
            const material5 = document.getElementById('newMaterial5').value;
            const quantity5 = document.getElementById('newQuantity5').value;
            
            // Calculate total cost
            let totalCost = 0;
            
            if (material1 !== "NONE" && quantity1) {
                const material = materials.find(m => m.name === material1);
                if (material) {
                    totalCost += material.costPerPiece * parseFloat(quantity1);
                }
            }
            
            if (material2 !== "NONE" && quantity2) {
                const material = materials.find(m => m.name === material2);
                if (material) {
                    totalCost += material.costPerPiece * parseFloat(quantity2);
                }
            }
            
            if (material3 !== "NONE" && quantity3) {
                const material = materials.find(m => m.name === material3);
                if (material) {
                    totalCost += material
                    if (material3 !== "NONE" && quantity3) {
                const material = materials.find(m => m.name === material3);
                if (material) {
                    totalCost += material.costPerPiece * parseFloat(quantity3);
                }
            }
            
            if (material4 !== "NONE" && quantity4) {
                const material = materials.find(m => m.name === material4);
                if (material) {
                    totalCost += material.costPerPiece * parseFloat(quantity4);
                }
            }
            
            if (material5 !== "NONE" && quantity5) {
                const material = materials.find(m => m.name === material5);
                if (material) {
                    totalCost += material.costPerPiece * parseFloat(quantity5);
                }
            }
            
            // Create new product
            const newProduct = {
                name: productName,
                materials: [material1, material2, material3, material4, material5],
                quantities: [quantity1, quantity2, quantity3, quantity4, quantity5],
                totalCost: totalCost
            };
            
            productRecipes.push(newProduct);
            
            // Save to localStorage
            localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
            
            // Update UI
            loadProductOptions();
            loadProductRecipes();
            updateDashboard();
            
            // Clear form
            document.getElementById('newProductName').value = '';
            document.getElementById('newMaterial1').value = 'NONE';
            document.getElementById('newQuantity1').value = '';
            document.getElementById('newMaterial2').value = 'NONE';
            document.getElementById('newQuantity2').value = '';
            document.getElementById('newMaterial3').value = 'NONE';
            document.getElementById('newQuantity3').value = '';
            document.getElementById('newMaterial4').value = 'NONE';
            document.getElementById('newQuantity4').value = '';
            document.getElementById('newMaterial5').value = 'NONE';
            document.getElementById('newQuantity5').value = '';
            
            alert('Product added successfully!');
        }

        // Add new material
        function addNewMaterial() {
            const name = document.getElementById('newMaterialName').value.trim();
            
            if (!name) {
                alert('Please enter a material name');
                return;
            }
            
            // Check if material already exists
            if (materials.some(m => m.name === name)) {
                alert('A material with this name already exists');
                return;
            }
            
            const qtyPerPack = parseInt(document.getElementById('newQtyPerPack').value) || 0;
            const totalAmount = parseFloat(document.getElementById('newTotalAmount').value) || 0;
            
            if (qtyPerPack <= 0 || totalAmount <= 0) {
                alert('Please enter valid quantity and amount values');
                return;
            }
            
            // Calculate cost per piece
            const costPerPiece = totalAmount / qtyPerPack;
            
            // Create new material
            const newMaterial = {
                name: name,
                qtyPerPack: qtyPerPack,
                totalAmount: totalAmount,
                costPerPiece: costPerPiece
            };
            
            materials.push(newMaterial);
            
            // Save to localStorage
            localStorage.setItem('materials', JSON.stringify(materials));
            
            // Update UI
            loadMaterialsDatabase();
            loadMaterialOptions();
            
            // Clear form
            document.getElementById('newMaterialName').value = '';
            document.getElementById('newQtyPerPack').value = '';
            document.getElementById('newTotalAmount').value = '';
            
            alert('Material added successfully!');
        }

        // Export products to CSV
        function exportProducts() {
            let csvContent = 'Name,Material1,Quantity1,Material2,Quantity2,Material3,Quantity3,Material4,Quantity4,Material5,Quantity5,TotalCost\n';
            
            productRecipes.forEach(product => {
                csvContent += `"${product.name}",`;
                
                // Handle all 5 materials and quantities
                for (let i = 0; i < 5; i++) {
                    const material = product.materials[i] || '';
                    const quantity = product.quantities[i] || '';
                    
                    csvContent += `"${material}",`;
                    csvContent += `"${quantity}",`;
                }
                
                csvContent += `"${product.totalCost}"\n`;
            });
            
            downloadCSV(csvContent, 'product_recipes.csv');
        }

        // Export materials to CSV
        function exportMaterials() {
            let csvContent = 'Name,QuantityPerPack,TotalAmount,CostPerPiece\n';
            
            materials.forEach(material => {
                // Skip the "NONE" placeholder
                if (material.name === "NONE") return;
                
                csvContent += `"${material.name}",`;
                csvContent += `"${material.qtyPerPack}",`;
                csvContent += `"${material.totalAmount}",`;
                csvContent += `"${material.costPerPiece}"\n`;
            });
            
            downloadCSV(csvContent, 'materials.csv');
        }

        // Helper function to download CSV
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            // Create download link
            if (navigator.msSaveBlob) { // For IE
                navigator.msSaveBlob(blob, filename);
            } else {
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Upload products CSV
        function uploadProductsCSV() {
            const fileInput = document.getElementById('productUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file');
                return;
            }
            
            const reader = new FileReader();
            reader.readAsText(file);
            
            reader.onload = function(event) {
                const csvData = event.target.result;
                const lines = csvData.split('\n');
                
                // Skip header row
                const newProducts = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const columns = lines[i].split(',');
                    
                    // Clean up CSV values (remove quotes)
                    for (let j = 0; j < columns.length; j++) {
                        columns[j] = columns[j].replace(/^"(.*)"$/, '$1');
                    }
                    
                    if (columns.length >= 12) { // Updated for 5 materials + quantities
                        const name = columns[0];
                        const material1 = columns[1] || "NONE";
                        const quantity1 = columns[2] || "";
                        const material2 = columns[3] || "NONE";
                        const quantity2 = columns[4] || "";
                        const material3 = columns[5] || "NONE";
                        const quantity3 = columns[6] || "";
                        const material4 = columns[7] || "NONE";
                        const quantity4 = columns[8] || "";
                        const material5 = columns[9] || "NONE";
                        const quantity5 = columns[10] || "";
                        const totalCost = parseFloat(columns[11]) || 0;
                        
                        newProducts.push({
                            name: name,
                            materials: [material1, material2, material3, material4, material5],
                            quantities: [quantity1, quantity2, quantity3, quantity4, quantity5],
                            totalCost: totalCost
                        });
                    }
                }
                
                // Replace existing products
                if (newProducts.length > 0) {
                    productRecipes = newProducts;
                    
                    // Save to localStorage
                    localStorage.setItem('productRecipes', JSON.stringify(productRecipes));
                    
                    // Update UI
                    loadProductOptions();
                    loadProductRecipes();
                    updateDashboard();
                    
                    alert(`Successfully imported ${newProducts.length} products`);
                } else {
                    alert('No valid data found in the CSV file');
                }
            };
            
            reader.onerror = function() {
                alert('Error reading the CSV file');
            };
        }

        // Upload materials CSV
        function uploadMaterialsCSV() {
            const fileInput = document.getElementById('materialUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file');
                return;
            }
            
            const reader = new FileReader();
            reader.readAsText(file);
            
            reader.onload = function(event) {
                const csvData = event.target.result;
                const lines = csvData.split('\n');
                
                // Skip header row
                const newMaterials = [];
                
                // Keep the "NONE" placeholder
                newMaterials.push({ name: "NONE", qtyPerPack: 0, totalAmount: 0, costPerPiece: 0 });
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const columns = lines[i].split(',');
                    
                    // Clean up CSV values (remove quotes)
                    for (let j = 0; j < columns.length; j++) {
                        columns[j] = columns[j].replace(/^"(.*)"$/, '$1');
                    }
                    
                    if (columns.length >= 4) {
                        const name = columns[0];
                        const qtyPerPack = parseInt(columns[1]) || 0;
                        const totalAmount = parseFloat(columns[2]) || 0;
                        const costPerPiece = parseFloat(columns[3]) || 0;
                        
                        newMaterials.push({
                            name: name,
                            qtyPerPack: qtyPerPack,
                            totalAmount: totalAmount,
                            costPerPiece: costPerPiece
                        });
                    }
                }
                
                // Replace existing materials
                if (newMaterials.length > 1) { // More than just the "NONE" placeholder
                    materials = newMaterials;
                    
                    // Save to localStorage
                    localStorage.setItem('materials', JSON.stringify(materials));
                    
                    // Update UI
                    loadMaterialsDatabase();
                    loadMaterialOptions();
                    
                    alert(`Successfully imported ${newMaterials.length - 1} materials`);
                } else {
                    alert('No valid data found in the CSV file');
                }
            };
            
            reader.onerror = function() {
                alert('Error reading the CSV file');
            };
        }
    </script>
</body>
</html>
